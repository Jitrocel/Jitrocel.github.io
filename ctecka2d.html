// Importujeme potřebné knihovny
const QRCode = require('qrcode-reader');
const Jimp = require('jimp');
const fs = require('fs');
const L = require('leaflet');

// Načteme QR kód
Jimp.read('cesta_k_qr_kodu.png', function(err, image) {
    if (err) {
        console.error(err);
        // Chyba při načítání obrázku
        return;
    }
    let qr = new QRCode();
    qr.callback = function(err, value) {
        if (err) {
            console.error(err);
            // Chyba při dekódování QR kódu
            return;
        }
        // Rozdělíme souřadnice na zeměpisnou šířku a délku
        let coordinates = value.result.split(',');
        let lon = coordinates[0];
        let lat = coordinates[1];

        // Načteme .geojson soubor
        fs.readFile('cesta_k_geojson_souboru.geojson', 'utf8', function(err, data) {
            if (err) {
                console.error(err);
                // Chyba při načítání .geojson souboru
                return;
            }
            let geojson = JSON.parse(data);

            // Projdeme všechny prvky v .geojson souboru
            for (let feature of geojson.features) {
                // Porovnáme souřadnice
                if (feature.geometry.coordinates[0] === lon &&
                    feature.geometry.coordinates[1] === lat) {
                    // Pokud se souřadnice shodují, vypíšeme alert
                    alert('Souřadnice: ' + lon + ', ' + lat +
                          '\nNázev místa: ' + feature.properties.name);
                    break;
                }
            }

            // Vytvoříme mapu a zaneseme do ní naskenované souřadnice
            let map = L.map('mapid').setView([lat, lon], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
            }).addTo(map);
            L.marker([lat, lon]).addTo(map);
        });
    };
    qr.decode(image.bitmap);
});
